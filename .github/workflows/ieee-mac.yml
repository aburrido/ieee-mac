name: Daily IEEE Standards Sync

on:
  schedule:
    - cron: '10 8 * * *' # 每天 08:10 UTC
  workflow_dispatch:

jobs:
  download-and-backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # 关键点 1: 依然排除 history 目录以节省带宽
          sparse-checkout: |
            /*
            !/history
          sparse-checkout-cone-mode: false
          # 关键点 2: 必须确保 fetch 深度，否则无法 push
          fetch-depth: 0 

      - name: Download and Prepare
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "DATE=$DATE" >> $GITHUB_ENV
          mkdir -p history/$DATE
          
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:102.0) Gecko/20100101 Firefox/102.0"
          
          # 定义文件列表
          declare -A FILES=(
            "https://standards-oui.ieee.org/oui/oui.txt|oui.txt"
            "https://standards-oui.ieee.org/oui/oui.csv|oui.csv"
            "https://standards-oui.ieee.org/oui28/mam.txt|mam.txt"
            "https://standards-oui.ieee.org/oui28/mam.csv|mam.csv"
            "https://standards-oui.ieee.org/oui36/oui36.txt|oui36.txt"
            "https://standards-oui.ieee.org/oui36/oui36.csv|oui36.csv"
            "https://standards-oui.ieee.org/cid/cid.txt|cid.txt"
            "https://standards-oui.ieee.org/cid/cid.csv|cid.csv"
            "https://standards-oui.ieee.org/ethertype/eth.txt|eth.txt"
            "https://standards-oui.ieee.org/ethertype/eth.csv|eth.csv"
            "https://standards-oui.ieee.org/manid/manid.txt|manid.txt"
            "https://standards-oui.ieee.org/manid/manid.csv|manid.csv"
            "https://standards-oui.ieee.org/bopid/opid.txt|opid.txt"
            "https://standards-oui.ieee.org/bopid/opid.csv|opid.csv"
            "https://standards-oui.ieee.org/iab/iab.txt|iab.txt"
            "https://standards-oui.ieee.org/iab/iab.csv|iab.csv"
          )

          for url in "${!FILES[@]}"; do
            filename=${FILES[$url]}
            wget --user-agent="$UA" "$url" -O "$filename"
            cp "$filename" "history/$DATE/$filename"
          done

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 关键点 3: 更新索引，允许 git 知道我们要在不下载 history 的情况下推送它
          git add .
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes detected."
          else
            git commit -m "Auto-sync: ${{ env.DATE }}"
            
            # 关键点 4: 使用 pull --rebase 解决非快进错误
            # 即使 history 被排除，rebase 也能处理元数据冲突
            git pull origin ${{ github.ref_name }} --rebase
            git push origin ${{ github.ref_name }}
          fi
