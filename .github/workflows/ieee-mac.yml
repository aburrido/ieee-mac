name: Daily IEEE Standards Sync

on:
  schedule:
    - cron: '10 8 * * *' # 每天 08:10 UTC
  workflow_dispatch:      # 允许手动触发

jobs:
  download-and-backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Root Files Only (Sparse Checkout)
        uses: actions/checkout@v4
        with:
          # 关键点：只拉取根目录文件，不拉取 history 目录
          sparse-checkout: |
            /*
            !/history
          sparse-checkout-cone-mode: false

      - name: Prepare Directories
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "DATE=$DATE" >> $GITHUB_ENV
          # 仅在本地创建今天的备份目录，不影响远程历史数据
          mkdir -p history/$DATE

      - name: Download Files
        run: |
          FILES=(
            "https://standards-oui.ieee.org/oui/oui.txt|oui.txt"
            "https://standards-oui.ieee.org/oui/oui.csv|oui.csv"
            "https://standards-oui.ieee.org/oui28/mam.txt|mam.txt"
            "https://standards-oui.ieee.org/oui28/mam.csv|mam.csv"
            "https://standards-oui.ieee.org/oui36/oui36.txt|oui36.txt"
            "https://standards-oui.ieee.org/oui36/oui36.csv|oui36.csv"
            "https://standards-oui.ieee.org/cid/cid.txt|cid.txt"
            "https://standards-oui.ieee.org/cid/cid.csv|cid.csv"
            "https://standards-oui.ieee.org/ethertype/eth.txt|eth.txt"
            "https://standards-oui.ieee.org/ethertype/eth.csv|eth.csv"
            "https://standards-oui.ieee.org/manid/manid.txt|manid.txt"
            "https://standards-oui.ieee.org/manid/manid.csv|manid.csv"
            "https://standards-oui.ieee.org/bopid/opid.txt|opid.txt"
            "https://standards-oui.ieee.org/bopid/opid.csv|opid.csv"
            "https://standards-oui.ieee.org/iab/iab.txt|iab.txt"
            "https://standards-oui.ieee.org/iab/iab.csv|iab.csv"
          )
          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:102.0) Gecko/20100101 Firefox/102.0"

          for entry in "${FILES[@]}"; do
            IFS="|" read -r URL FILENAME <<< "$entry"
            echo "Downloading $FILENAME..."
            wget --user-agent="$UA" "$URL" -O "$FILENAME"
            cp "$FILENAME" "history/${{ env.DATE }}/$FILENAME"
          done

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 告诉 Git 包含今天的备份目录
          # 虽然 checkout 时排除了 history，但 add 会强制将新创建的目录放入暂存区
          git add *.txt *.csv
          git add history/${{ env.DATE }}/

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes detected."
          else
            git commit -m "Auto-sync: ${{ env.DATE }}"
            # push 会将新文件推送到远程，但下次运行依然不会下载 history 目录
            git push origin main
